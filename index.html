<html>
<head>
<title>ThermoController</title>
<link rel="stylesheet" href="js/dijit/themes/claro/claro.css">
<link rel="stylesheet" href="js/dgrid/css/dgrid.css">
<link rel="stylesheet" href="index.css">
<script>dojoConfig = {parseOnLoad: true}</script>
<script src="js/dojo/dojo.js" data-dojo-config="async: true"></script>
</head>
<body style="width: 100%; height: 100%;" class="claro">

<div id="modsel">
	<div id="modsel-manual">
		Manual Mode
		<button id="modsel-manual-btn"></button>
	</div>
	<div id="modsel-auto">
		Auto Mode
		<button id="modsel-auto-btn"></button>
	</div>
</div>

<div class="clear" id="mode-stack"></div>

<script>
var system_status;

var modeStack;
var autoPane;
var manualPane;
var autoBtn;
var manualBtn;
// For manual
var pelletOnBtn;
var pelletOffBtn;
var gasOnBtn;
var gasOffBtn;

require(["dijit/form/Button", 
	 "dojo/request",
	 "dojo/dom", 
	 "dojo/dom-attr",
	 "dojo/dom-class",
	 "dojo/dom-style",
	 "dijit/registry",
	 "dijit/ConfirmDialog",
	 "dijit/layout/ContentPane",
	 "dijit/layout/StackContainer",
	 "dojo/on",
	 "dojo/domReady!"], 
function(Button, request, dom, attr, dclass, style, registry, ConfirmDialog, ContentPane, StackContainer, on)
{
	function executeCommand(cmd) {
       		request.put("/cgi-bin/command", {data:cmd}).then(
			function(result){
				updateStatus();
			},
			function(err){
				alert("Command error: " + err );
			});
	}

	function pelletOn() {
	}
	function pelletOff() {
		if ( system_status ) 
		{
			var dialog = new ConfirmDialog({
        			title: "ATTENZIONE!",
        			content: "Spegno il PELLET?"});
			dialog.set("buttonOk", "Spegni!");
			dialog.set("buttonCancel", "Annulla");
			dialog.on("execute", function(){executeCommand("pellet_off");});
			dialog.show();
		}
		else
			alert("Sistema non caricato");
	}
	function gasOn() {
	}
	function gasOff() {
	}
	function setAutoMode(warn) {
		function setMode() {
			dclass.add( "modsel-auto", "modselected" );
			dclass.remove( "modsel-manual", "modselected" );
			modeStack.selectChild( autoPane );
		}
		if ( system_status.mode != "auto" ) {
			setMode();
		}
		else
			setMode();
	}

	function setManualMode(warn) {
		function setMode() {
			dclass.add( "modsel-manual", "modselected" );
			dclass.remove( "modsel-auto", "modselected" );
			modeStack.selectChild( manualPane );
		}
		if ( system_status.mode != "manual" ) {
			setMode();
		}
		else
			setMode();
	}

	function updateStatus()
	{
       		request("status" , {handleAs :"json"}).then(
			function(result)
			{
				system_status = result;
				if ( system_status.mode == "auto" )
					setAutoMode(false);
				else
					setManualMode(false);
	
				if ( system_status.pellet.command == "on" )
				{
					attr.set("pellet-status-led", "src", "images/pellet-on.png");
					pelletOnBtn.set("disabled", true );
					pelletOffBtn.set("disabled", false );
				}
				else
				{
					attr.set("pellet-status-led", "src", "images/pellet-off.png");
					pelletOnBtn.set("disabled", false );
					pelletOffBtn.set("disabled", true );
				}
			}, 
			function(err)
			{
				alert("Impossibile caricare lo stato del sistema: "+err);
			})

	}








	modeStack = new StackContainer({}, 
		"mode-stack");
	autoPane = new ContentPane({
		href: "auto.html",
		}, "auto-pane" );
	autoPane.startup();
	manualPane = new ContentPane({
		href: "manual.html",
		onLoad: function() {
				pelletOnBtn = new Button({
					label: "Accendi",
					disabled: true,
					onClick: pelletOn
				}, "pellet-on-btn");
				pelletOnBtn.startup();
				pelletOffBtn = new Button({
					label: "Spegni",
					disabled: true,
					onClick: pelletOff
				}, "pellet-off-btn");
				pelletOffBtn.startup();
			}
		}, "manual-pane" );
	manualPane.startup();
	modeStack.addChild( autoPane );
	modeStack.addChild( manualPane );
	modeStack.selectChild( manualPane );
	modeStack.startup();

	manualBtn = new Button({
		label: "Manual",
		onClick: setManualMode,
		}, "modsel-manual-btn");
	manualBtn.startup();
	autoBtn = new Button({
		label: "Auto",
		onClick: setAutoMode,
		}, "modsel-auto-btn");
	autoBtn.startup();


	updateStatus();
});

</script>
</body>
</html>
