<html>
<head>
<title>ThermoController</title>
<link rel="stylesheet" href="js/dijit/themes/claro/claro.css">
<link rel="stylesheet" href="js/dgrid/css/dgrid.css">
<link rel="stylesheet" href="index.css">
<script>dojoConfig = {parseOnLoad: true}</script>
<script src="js/dojo/dojo.js" data-dojo-config="async: true"></script>
</head>
<body style="width: 100%; height: 100%;" class="claro">

<div id="history-pane">
	<div id="history"></div>
</div>

<div id="modsel">
	<div id="modsel-manual" class="modunselected">
		<button id="modsel-manual-btn"></button>
	</div>
	<div id="modsel-auto" class="modselected">
		<button id="modsel-auto-btn"></button>
	</div>
	<div id="modsel-program" class="modselected">
		<button id="modsel-program-btn"></button>
	</div>
</div>

<div class="clear" id="mode-stack"></div>

<script>
var system_status;
// History:
var historyGraph;

var modeStack;
var autoPane;
var manualPane;
var programPane;
var autoBtn;
var manualBtn;
var programBtn;
// For manual
var pelletOnBtn;
var pelletOffBtn;
var gasOnBtn;
var gasOffBtn;
// For auto:
var highlightCells;

require(["dijit/form/Button", 
	 "dojo/request",
	 "dojo/dom", 
	 "dojo/dom-attr",
	 "dojo/dom-class",
	 "dojo/dom-style",
	 "dojo/html",
	 "dijit/registry",
	 "dijit/ConfirmDialog",
	 "dijit/layout/ContentPane",
	 "dijit/layout/StackContainer",
	 "dojox/charting/Chart",
	 "dojox/charting/axis2d/Default", 
	 "dojox/charting/plot2d/Lines",
	 "dojo/on",
	 "dojo/domReady!"], 
function(Button, request, dom, attr, dclass, style, html, registry, ConfirmDialog, ContentPane, StackContainer, Chart, Default, Lines, on)
{
	function executeCommand(cmd) {
       		request.put("/cgi-bin/command", {data:cmd}).then(
			function(result){
				updateStatus();
			},
			function(err){
				alert("Command error: " + err );
			});
	}

	function pelletOn() {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Accendo il PELLET?"});
		dialog.set("buttonOk", "Accendi!");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("pellet_on");});
		dialog.show();
	}
	function pelletOff() {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Spegno il PELLET?"});
		dialog.set("buttonOk", "Spegni!");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("pellet_off");});
		dialog.show();
	}
	function gasOn() {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Accendo il GAS?"});
		dialog.set("buttonOk", "Accendi!");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("gas_on");});
		dialog.show();
	}
	function gasOff() {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Spegno il GAS?"});
		dialog.set("buttonOk", "Spegni!");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("gas_off");});
		dialog.show();
	}
	function setAutoMode(warn) {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Pssare in automatico?"});
		dialog.set("buttonOk", "Passa in auto");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("auto");});
		dialog.show();
	}
	function setManualMode(warn) {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Pssare in manuale?"});
		dialog.set("buttonOk", "Passa in manuale");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("manual");});
		dialog.show();
	}
	function setProgramMode(warn){
		executeCommand("program");
	}
	function programRefresh(){
		if ( dom.byId( "auto-table" ) ) {
		var nd = system_status.now.d;
		var nh = system_status.now.h;
		var nf = system_status.now.f;
		if ( highlightCells )
			highlightCells.forEach( function(i,x){
					dclass.remove( i, "auto_now_h auto_now_c");
				});
		highlightCells = [];
		for ( var d = 0; d < 7; d++ ){
			if ( d == nd ){
				dclass.add( "auto-day-"+nd, "auto_now_h" );
				highlightCells.push( "auto-day-"+nd );
			}
			for ( var h = 0; h < 24; h++ ){
				if ( d == nd && h == nh ){
					dclass.add( "auto-header-"+(nh<10?"0":"")+nh, "auto_now_h" );
					highlightCells.push( "auto-header-"+(nh<10?"0":"")+nh );
				}
				for ( var f = 0; f < 2; f++ ){
					if ( d == nd && h == nh && f == nf ){
						dclass.add( "auto-header-"+(nh<10?"0":"")+nh+""+(nf==0?"00":"30"), "auto_now_h" );
						highlightCells.push( "auto-header-"+(nh<10?"0":"")+nh+""+(nf==0?"00":"30") );
					}
					var i = "auto-cell-"+d+"-"+(h < 10 ? "0"+h:h)+(f==0?"00":"30");
					var c = system_status.program[d][h*2+f];
					var s = c==''?"":'<img src="images/';
					if ( c == 'p' ) s+='pellet.png"/>';
					if ( c == 'g' ) s+='gas.png"/>';
					if ( c == 'x' ) s+='pellet-gas.png"/>';
					var n = dom.byId(i);
					html.set(n,s);
					if ( (d == nd) && (h!=nh || f!=nf)  ){
						dclass.add(n, "auto_now_c" );
						highlightCells.push( n );
					}else if ( (d != nd) && (h==nh && f == nf) ){
						dclass.add( n, "auto_now_c" );
						highlightCells.push( n );
					}else if ( d == nd && h == nh && f == nf ){
						dclass.add( "auto-cell-"+nd+"-"+(nh<10?"0":"")+nh+""+(nf==0?"00":"30"), "auto_now_h" );
						highlightCells.push( "auto-cell-"+nd+"-"+(nh<10?"0":"")+nh+""+(nf==0?"00":"30") );
					}
				}
			}
		}
		}
	}


	function updateStatus()
	{
       		request("cgi-bin/status" , {handleAs :"json"}).then(
			function(result)
			{
				system_status = result;
				if ( system_status.mode == "auto" ){
					dclass.add( "modsel-auto", "modselected" );
					dclass.remove( "modsel-auto", "modunselected" );
					dclass.remove("modsel-manual", "modselected" );
					dclass.remove("modsel-program", "modselected" );
					dclass.add( "modsel-manual", "modunselected" );
					dclass.add( "modsel-program", "modunselected" );
					modeStack.selectChild( autoPane );
					programRefresh();
				}else if ( system_status.mode == "manual" ) {
					dclass.add( "modsel-manual", "modselected" );
					dclass.remove( "modsel-manual", "modunselected" );
					dclass.remove( "modsel-auto", "modselected" );
					dclass.remove( "modsel-program", "modselected" );
					dclass.add( "modsel-auto", "modunselected" );
					dclass.add( "modsel-program", "modunselected" );
					modeStack.selectChild( manualPane );
					if ( system_status.pellet.command == "on" ){
						attr.set("pellet-status-led", "src", "images/pellet-on.png");
						pelletOnBtn.set("disabled", true );
						pelletOffBtn.set("disabled", false );
					}else{
						attr.set("pellet-status-led", "src", "images/pellet-off.png");
						pelletOnBtn.set("disabled", false );
						pelletOffBtn.set("disabled", true );
					}
					if ( system_status.gas.command == "on" ){
						attr.set("gas-status-led", "src", "images/gas-on.png");
						gasOnBtn.set("disabled", true );
						gasOffBtn.set("disabled", false );
					}else{
						attr.set("gas-status-led", "src", "images/gas-off.png");
						gasOnBtn.set("disabled", false );
						gasOffBtn.set("disabled", true );
					}
				}else if ( system_status.mode == "program" ){
					dclass.add( "modsel-program", "modselected" );
					dclass.remove( "modsel-program", "modunselected" );
					dclass.remove( "modsel-auto", "modselected" );
					dclass.remove( "modsel-manual", "modselected" );
					dclass.add( "modsel-auto", "modunselected" );
					dclass.add( "modsel-manual", "modunselected" );
					modeStack.selectChild( programPane );
				}
				window.setTimeout( function(){ updateStatus(); }, 5000 );
			}, 
			function(err)
			{
				alert("Impossibile caricare lo stato del sistema: "+err);
			})

	}

	function updateHistory()
	{
       		request("cgi-bin/history" , {handleAs :"json"}).then(
			function(result){
				historyGraph.updateSeries("Temp", result );
				historyGraph.render();
				window.setTimeout( function(){ updateHistory(); }, 60 * 1000 );
			},
			function(err){
				alert("Impossibile caricare la storia: "+err);
			});
	}







	modeStack = new StackContainer({}, 
		"mode-stack");
	autoPane = new ContentPane({
		href: "auto.html",
		onLoad: function() {
				programRefresh();
			}
		}, "auto-pane" );
	autoPane.startup();
	manualPane = new ContentPane({
		href: "manual.html",
		onLoad: function() {
				pelletOnBtn = new Button({
					label: "Accendi",
					disabled: true,
					onClick: pelletOn
				}, "pellet-on-btn");
				pelletOnBtn.startup();
				pelletOffBtn = new Button({
					label: "Spegni",
					disabled: true,
					onClick: pelletOff
				}, "pellet-off-btn");
				pelletOffBtn.startup();
				gasOnBtn = new Button({
					label: "Accendi",
					disabled: true,
					onClick: gasOn
				}, "gas-on-btn");
				gasOnBtn.startup();
				gasOffBtn = new Button({
					label: "Spegni",
					disabled: true,
					onClick: gasOff
				}, "gas-off-btn");
				gasOffBtn.startup();
			}
		}, "manual-pane" );
	manualPane.startup();
	programPane = new ContentPane({
		href: "program.html",
		}, "program_pane" );
	programPane.startup();
	modeStack.addChild( autoPane );
	modeStack.addChild( manualPane );
	modeStack.addChild( programPane );
	modeStack.selectChild( manualPane );
	modeStack.startup();

	manualBtn = new Button({
		label: "Manual",
		onClick: setManualMode,
		}, "modsel-manual-btn");
	manualBtn.startup();
	autoBtn = new Button({
		label: "Auto",
		onClick: setAutoMode,
		}, "modsel-auto-btn");
	autoBtn.startup();
	programBtn = new Button({
		label: "Programma",
		onClick: setProgramMode,
		}, "modsel-program-btn");
	programBtn.startup();
	

	historyGraph = new Chart("history");
	historyGraph.addPlot("default", {type: Lines});
	historyGraph.addAxis("x");
	historyGraph.addAxis("y", {vertical: true});
	historyGraph.addSeries("Temp", [], {stroke: {color: "red", width: 2}} );
	historyGraph.render();

	updateHistory();
	updateStatus();
});

</script>
</body>
</html>
