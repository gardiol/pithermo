<html>
<head>
<title>ThermoController</title>
<link rel="stylesheet" href="js/dijit/themes/claro/claro.css">
<link rel="stylesheet" href="js/dgrid/css/dgrid.css">
<link rel="stylesheet" href="index.css">
<script>dojoConfig = {parseOnLoad: true}</script>
<script src="js/dojo/dojo.js" data-dojo-config="async: true"></script>
</head>
<body style="width: 100%; height: 100%;" class="claro">

<div id="history"></div>

<div id="modsel">
	<div id="modsel-manual">
		Manual Mode
		<button id="modsel-manual-btn"></button>
	</div>
	<div id="modsel-auto">
		Auto Mode
		<button id="modsel-auto-btn"></button>
	</div>
</div>

<div class="clear" id="mode-stack"></div>

<script>
var system_status;
// History:
var historyGraph;

var modeStack;
var autoPane;
var manualPane;
var autoBtn;
var manualBtn;
// For manual
var pelletOnBtn;
var pelletOffBtn;
var gasOnBtn;
var gasOffBtn;

require(["dijit/form/Button", 
	 "dojo/request",
	 "dojo/dom", 
	 "dojo/dom-attr",
	 "dojo/dom-class",
	 "dojo/dom-style",
	 "dojo/html",
	 "dijit/registry",
	 "dijit/ConfirmDialog",
	 "dijit/layout/ContentPane",
	 "dijit/layout/StackContainer",
	 "dojox/charting/Chart",
	 "dojox/charting/axis2d/Default", 
	 "dojox/charting/plot2d/Lines",
	 "dojo/on",
	 "dojo/domReady!"], 
function(Button, request, dom, attr, dclass, style, html, registry, ConfirmDialog, ContentPane, StackContainer, Chart, Default, Lines, on)
{
	function executeCommand(cmd) {
       		request.put("/cgi-bin/command", {data:cmd}).then(
			function(result){
				updateStatus();
			},
			function(err){
				alert("Command error: " + err );
			});
	}

	function pelletOn() {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Accendo il PELLET?"});
		dialog.set("buttonOk", "Accendi!");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("pellet_on");});
		dialog.show();
	}
	function pelletOff() {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Spegno il PELLET?"});
		dialog.set("buttonOk", "Spegni!");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("pellet_off");});
		dialog.show();
	}
	function gasOn() {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Accendo il GAS?"});
		dialog.set("buttonOk", "Accendi!");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("gas_on");});
		dialog.show();
	}
	function gasOff() {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Spegno il GAS?"});
		dialog.set("buttonOk", "Spegni!");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("gas_off");});
		dialog.show();
	}
	function setAutoMode(warn) {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Pssare in automatico?"});
		dialog.set("buttonOk", "Passa in auto");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("auto");});
		dialog.show();
	}
	function setManualMode(warn) {
		var dialog = new ConfirmDialog({
        		title: "ATTENZIONE!",
        		content: "Pssare in manuale?"});
		dialog.set("buttonOk", "Passa in manuale");
		dialog.set("buttonCancel", "Annulla");
		dialog.on("execute", function(){executeCommand("manual");});
		dialog.show();
	}
	function programRefresh(){
		for ( var d = 0; d < 7; d++ ){
			for ( var h = 0; h < 24; h++ ){
				for ( var f = 0; f < 2; f++ ){
					var i = "auto-cell-"+d+"-"+(h < 10 ? "0"+h:h)+(f==0?"00":"30");
					var c = system_status.program[d][h*2+f];
					var s = c==''?"":'<img src="images/';
					if ( c == 'p' ) s+='pellet.png"/>';
					if ( c == 'g' ) s+='gas.png"/>';
					if ( c == 'x' ) s+='pellet-gas.png"/>';
					var n = dom.byId(i);
					if (n) html.set(n,s);
				}
			}
		}
	}


	function updateStatus()
	{
       		request("cgi-bin/status" , {handleAs :"json"}).then(
			function(result)
			{
				system_status = result;
				if ( system_status.mode == "auto" ){
					dclass.add( "modsel-auto", "modselected" );
					dclass.remove( "modsel-manual", "modselected" );
					modeStack.selectChild( autoPane );
					programRefresh();
				}else{
					dclass.add( "modsel-manual", "modselected" );
					dclass.remove( "modsel-auto", "modselected" );
					modeStack.selectChild( manualPane );
					if ( system_status.pellet.command == "on" ){
						attr.set("pellet-status-led", "src", "images/pellet-on.png");
						pelletOnBtn.set("disabled", true );
						pelletOffBtn.set("disabled", false );
					}else{
						attr.set("pellet-status-led", "src", "images/pellet-off.png");
						pelletOnBtn.set("disabled", false );
						pelletOffBtn.set("disabled", true );
					}
					if ( system_status.gas.command == "on" ){
						attr.set("gas-status-led", "src", "images/gas-on.png");
						gasOnBtn.set("disabled", true );
						gasOffBtn.set("disabled", false );
					}else{
						attr.set("gas-status-led", "src", "images/gas-off.png");
						gasOnBtn.set("disabled", false );
						gasOffBtn.set("disabled", true );
					}
				}
				window.setTimeout( function(){ updateStatus(); }, 5000 );
			}, 
			function(err)
			{
				alert("Impossibile caricare lo stato del sistema: "+err);
			})

	}

	function updateHistory()
	{
       		request("cgi-bin/history" , {handleAs :"json"}).then(
			function(result){
				historyGraph.updateSeries("Temp", result );
				historyGraph.render();
				window.setTimeout( function(){ updateHistory(); }, 60 * 1000 );
			},
			function(err){
				alert("Impossibile caricare la storia: "+err);
			});
	}







	modeStack = new StackContainer({}, 
		"mode-stack");
	autoPane = new ContentPane({
		href: "auto.html",
		onLoad: function() {
				programRefresh();
			}
		}, "auto-pane" );
	autoPane.startup();
	manualPane = new ContentPane({
		href: "manual.html",
		onLoad: function() {
				pelletOnBtn = new Button({
					label: "Accendi",
					disabled: true,
					onClick: pelletOn
				}, "pellet-on-btn");
				pelletOnBtn.startup();
				pelletOffBtn = new Button({
					label: "Spegni",
					disabled: true,
					onClick: pelletOff
				}, "pellet-off-btn");
				pelletOffBtn.startup();
				gasOnBtn = new Button({
					label: "Accendi",
					disabled: true,
					onClick: gasOn
				}, "gas-on-btn");
				gasOnBtn.startup();
				gasOffBtn = new Button({
					label: "Spegni",
					disabled: true,
					onClick: gasOff
				}, "gas-off-btn");
				gasOffBtn.startup();
			}
		}, "manual-pane" );
	manualPane.startup();
	modeStack.addChild( autoPane );
	modeStack.addChild( manualPane );
	modeStack.selectChild( manualPane );
	modeStack.startup();

	manualBtn = new Button({
		label: "Manual",
		onClick: setManualMode,
		}, "modsel-manual-btn");
	manualBtn.startup();
	autoBtn = new Button({
		label: "Auto",
		onClick: setAutoMode,
		}, "modsel-auto-btn");
	autoBtn.startup();

	historyGraph = new Chart("history");
	historyGraph.addPlot("default", {type: Lines});
	historyGraph.addAxis("x");
	historyGraph.addAxis("y", {vertical: true});
	historyGraph.addSeries("Temp", [], {stroke: {color: "red", width: 2}} );
	historyGraph.render();

	updateHistory();
	updateStatus();
});

</script>
</body>
</html>
